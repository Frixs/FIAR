@{
    ViewData["Title"] = "Lobby";
}

<div class="text-center">
    <h1 class="display-4">Lobby</h1>
</div>
<div class="container">
    <div class="row">
        <div class="col-lg-4">
            <div class="text-center">
                <h2>All Players</h2>
            </div>
            <table class="table player-table">
                <tbody id="all-users-tbody">
                </tbody>
            </table>
        </div>
        <div class="col-lg-4">
            <div class="text-center">
                <h2>Requests</h2>
            </div>
            <table class="table">
                <tbody>
                    <tr>
                        <td>Mark</td>
                        <td>Otto</td>
                        <td>mdo</td>
                    </tr>
                    <tr>
                        <th scope="row">2</th>
                        <td>Jacob</td>
                        <td>Thornton</td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td>Larry</td>
                        <td>the Bird</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-lg-4">
            <div class="text-center">
                <h2>Friend List</h2>
            </div>
            <table class="table player-table">
                <tbody id="friend-users-tbody">
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        // READY
        $(document).ready(function () {
            update();
        });

        // FUNCTION
        // Data update loop
        function update() {
            updateUsersFunction();
            updateFriendListFunction();

            // Repeat
            setTimeout(updateUsersFunction, 10_000);
            setTimeout(updateFriendListFunction, 10_000);
        }

        // FUNCTION
        // Update online users
        function updateUsersFunction() {
            // AJAX POST
            $.ajax({
                url: "@ApiRoutes.GetAllUserProfiles",
                type: "POST",
                dataType: "json",
                contentType: 'application/json;charset=utf-8',
                data: JSON.stringify({ IncludeRoleList: false, IncludeOnlineStatus: true, IncludeIsFriendWith: true, IncludeIsChallanged: true }),
                // Success
                success: function (data) {
                    //console.log(data);
                    $('#all-users-tbody').empty();
                    for (var i = 0; i < data.response.userModels.length; ++i) {
                        appendPlayerTableRow('#all-users-tbody', data.response.userModels[i]);
                    }
                    if (data.response.userModels.length == 0) {
                        $('#all-users-tbody').append(
                            '<tr>'
                            + '<td class="text-center">no players</td>'
                            + '</tr>'
                        );
                    }
                },
                // Error
                error: function (data) {
                    alert(data.status);
                    // If unauthorized error...
                    if (data.status == 401) {
                        window.alert = function () { };
                        window.location.href = "@(WebRoutes.Login)";
                    } else {
                        window.alert = function () { };
                        window.location.href = "@(WebRoutes.Error500)";
                    }
                }
            });
        }

        // FUNCTION
        // Update friend list
        function updateFriendListFunction() {
            // AJAX POST
            $.ajax({
                url: "@ApiRoutes.GetUserFriendProfiles",
                type: "POST",
                dataType: "json",
                contentType: 'application/json;charset=utf-8',
                data: JSON.stringify({ IncludeRoleList: false, IncludeOnlineStatus: true, IncludeIsFriendWith: true, IncludeIsChallanged: true }),
                // Success
                success: function (data) {
                    //console.log(data);
                    $('#friend-users-tbody').empty();
                    for (var i = 0; i < data.response.friendModels.length; ++i) {
                        appendPlayerTableRow('#friend-users-tbody', data.response.friendModels[i]);
                    }
                    if (data.response.friendModels.length == 0) {
                        $('#friend-users-tbody').append(
                            '<tr>'
                            + '<td class="text-center">no friends</td>'
                            + '</tr>'
                        );
                    }
                },
                // Error
                error: function (data) {
                    alert(data.status);
                    // If unauthorized error...
                    if (data.status == 401) {
                        window.alert = function () { };
                        window.location.href = "@(WebRoutes.Login)";
                    } else {
                        window.alert = function () { };
                        window.location.href = "@(WebRoutes.Error500)";
                    }
                }
            });
        }

        // FUNCTION
        // Append player data into a player table row
        function appendPlayerTableRow(ctx, user) {
            console.log(user);
            $(ctx).append(
                '<tr class="--' + (user.isOnline ? 'online' : 'offline') + '">'
                + '<td>' + user.nickname + '</td>'
                + '<td class="status-indicator"><i class="fas fa-circle"></i></td>'
                + '<td>' + (user.isChallanged ? '' : '<button class="btn btn-dark">CHALLANGE</button>') + '</td>'
                + '<td data-toggle="tooltip" title="' + (user.isFriendWith == null ? '' : (user.isFriendWith ? 'Remove from friend list' : 'Create a new friend request')) + '">' + (user.isFriendWith == null ? '' : (user.isFriendWith ? '<button class="btn btn-danger"><i class="fas fa-user-minus"></i></button>' : '<button class="btn btn-success"><i class="fas fa-user-plus"></i></button>')) + '</td>'
                + '</tr>'
            );
        }
    </script>
}